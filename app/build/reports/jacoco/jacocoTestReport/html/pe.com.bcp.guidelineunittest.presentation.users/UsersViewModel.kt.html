<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UsersViewModel.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">app</a> &gt; <a href="index.source.html" class="el_package">pe.com.bcp.guidelineunittest.presentation.users</a> &gt; <span class="el_source">UsersViewModel.kt</span></div><h1>UsersViewModel.kt</h1><pre class="source lang-java linenums">package pe.com.bcp.guidelineunittest.presentation.users

import androidx.annotation.VisibleForTesting
import androidx.databinding.ObservableField
import androidx.lifecycle.LiveData
import androidx.lifecycle.MutableLiveData
import androidx.lifecycle.ViewModel
import androidx.lifecycle.viewModelScope
import pe.com.bcp.guidelineunittest.commons.utils.Either
import pe.com.bcp.guidelineunittest.commons.utils.getOrElse
import pe.com.bcp.guidelineunittest.commons.utils.onFailure
import pe.com.bcp.guidelineunittest.domain.core.UseCase
import pe.com.bcp.guidelineunittest.domain.entity.UserEntity
import pe.com.bcp.guidelineunittest.domain.usecase.GetUsersUseCase
import pe.com.bcp.guidelineunittest.exception.Failure
import pe.com.bcp.guidelineunittest.presentation.commons.StatefulLayout
import pe.com.bcp.guidelineunittest.presentation.core.SingleLiveEvent
import pe.com.bcp.guidelineunittest.presentation.users.vo.UserListItemVO
import pe.com.bcp.guidelineunittest.presentation.users.vo.toViewObject

<span class="fc" id="L21">class UsersViewModel constructor(</span>
<span class="fc" id="L22">    private val getUsersUseCase: GetUsersUseCase,</span>
<span class="fc" id="L23">) : ViewModel() {</span>

<span class="fc" id="L25">    private val _goToDetails: SingleLiveEvent&lt;UserListItemVO&gt; = SingleLiveEvent()</span>
<span class="fc" id="L26">    val goToDetails: LiveData&lt;UserListItemVO&gt; = _goToDetails</span>

<span class="fc" id="L28">    private val _users: MutableLiveData&lt;List&lt;UserListItemVO&gt;&gt; = MutableLiveData()</span>
<span class="fc" id="L29">    val users: LiveData&lt;List&lt;UserListItemVO&gt;&gt; = _users</span>

<span class="fc" id="L31">    private val _failure: MutableLiveData&lt;Failure&gt; = SingleLiveEvent()</span>
<span class="fc" id="L32">    val failure: LiveData&lt;Failure&gt; = _failure</span>

<span class="fc" id="L34">    private var _isLoading = MutableLiveData&lt;Boolean&gt;()</span>
<span class="fc" id="L35">    val isLoading = _isLoading</span>

<span class="fc" id="L37">    val contentState = ObservableField&lt;String&gt;()</span>

    fun populate() {
<span class="pc bpc" id="L40" title="1 of 6 branches missed.">        if (users.value.isNullOrEmpty()) {</span>
<span class="fc" id="L41">            contentState.set(UsersState.LOADING)</span>
        }
<span class="fc" id="L43">        getUsersUseCase(UseCase.None, viewModelScope, ::handleGetUsersUseCaseResult)</span>
<span class="fc" id="L44">    }</span>

    fun refresh() {
<span class="fc" id="L47">        this.populate()</span>
<span class="fc" id="L48">    }</span>

    @VisibleForTesting
    fun handleGetUsersUseCaseResult(result: Either&lt;Failure, List&lt;UserEntity&gt;&gt;) {
<span class="fc bfc" id="L52" title="All 2 branches covered.">        if (result.isLeft) {</span>
<span class="fc" id="L53">            contentState.set(UsersState.ERROR)</span>
<span class="fc" id="L54">            result.onFailure {</span>
<span class="fc" id="L55">                handleFailure(it)</span>
<span class="fc" id="L56">            }</span>
        } else {
<span class="fc" id="L58">            val results = result.getOrElse(listOf())</span>

<span class="fc bfc" id="L60" title="All 2 branches covered.">            if(results.isEmpty()){</span>
<span class="fc" id="L61">                contentState.set(UsersState.EMPTY)</span>
            }else{
<span class="fc" id="L63">                contentState.set(UsersState.CONTENT)</span>
            }

<span class="fc" id="L66">            _users.value = results.map { it.toViewObject() }</span>
        }
<span class="fc" id="L68">        _isLoading.value = false</span>
<span class="fc" id="L69">    }</span>

    @VisibleForTesting
    fun handleFailure(failure: Failure) {
<span class="fc" id="L73">        _failure.value = failure</span>
<span class="fc" id="L74">    }</span>

    @VisibleForTesting
    fun setUsers(users: List&lt;UserListItemVO&gt;) {
<span class="fc" id="L78">        _users.value = users</span>
<span class="fc" id="L79">    }</span>

    fun handleItemPressed(item: UserListItemVO) {
<span class="fc" id="L82">        _goToDetails.value = item</span>
<span class="fc" id="L83">    }</span>
}

object UsersState {
    const val CONTENT = StatefulLayout.State.CONTENT
    const val EMPTY = &quot;STATE_EMPTY&quot;
    const val ERROR = &quot;STATE_ERROR&quot;
    const val LOADING = &quot;STATE_LOADING&quot;
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>